<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Comic Canvas</title>
	<link rel="stylesheet" href="style.css">
	<script src="script.js"></script>
</head>

<body>

	<div class="main-content">
		<!--General Context	-->
		<div id="settingForm" class="container">
			<h1 class="headline">Comic Canvas</h1>
			<input id="title" class="title" type="text" placeholder="Give your story a title..." maxlength="50">
			<textarea class="textbox" placeholder="Craft your own reality..." id="setting"></textarea>
			<div class="dropdowns">
				<select class="dropdown" id="style">
					<option value="">Select style</option>
					<option value="charliebo artstyle">Charliebo</option>
					<option value="holliemengert artstyle">Holliemengert</option>
					<option value="marioalberti artstyle">Marioalberti</option>
					<option value="pepelarraz artstyle">Pepelarraz</option>
					<option value="andreasrocha artstyle">Andreasrocha</option>
					<option value="jamesdaly artstyle">Jamesdaly</option>
				</select>
				<select class="dropdown" id="genre">
					<option value="">Select genre</option>
					<option value="Science Fiction">Science Fiction</option>
					<option value="Horror">Horror</option>
					<option value="Fantasy">Fantasy</option>
					<option value="Comedy">Comedy</option>
				</select>
			</div>
			<div class="characters">
				<hr>
				<h2>Characters</h2>
				<div class="character-images">
					<div class="image">
						<img src="images/placeholder.png" id="character_1_image">
						<div class="input-sections" id="character_1">
							<input class="name" type="text" placeholder="Name" id="character_1_name">
							<select class="gender-dropdown" id="character_1_gender">
								<option value="">Select gender</option>
								<option value="female">female</option>
								<option value="male">male</option>
								<option value="other">other</option>
							</select>
							<div class="mini-heading">appearance</div>
							<textarea class="description" placeholder="What do I look like?"
								id="character_1_look"></textarea>
							<div class="mini-heading">personality</div>
							<textarea class="description" placeholder="Bring me to life!"
								id="character_1_personality"></textarea>
						</div>
						<button class="refresh" id="character_1_refresh"
							onclick="regenerateCharacterImage('character_1')">Regenerate
							Image</button>
					</div>

					<div class="image">
						<img src="images/placeholder.png" id="character_2_image">
						<div class="input-sections" id="character_2">
							<input class="name" type="text" placeholder="Name" id="character_2_name">
							<select class="gender-dropdown" id="character_2_gender">
								<option value="">Select gender</option>
								<option value="female">female</option>
								<option value="male">male</option>
								<option value="other">other</option>
							</select>
							<div class="mini-heading">appearance</div>
							<textarea class="description" placeholder="What do I look like?"
								id="character_2_look"></textarea>
							<div class="mini-heading">personality</div>
							<textarea class="description" placeholder="Bring me to life!"
								id="character_2_personality"></textarea>
						</div>
						<button class="refresh" id="character_2_refresh"
							onclick="regenerateCharacterImage('character_2')">Regenerate
							Image</button>
					</div>

					<div class="image">
						<img src="images/placeholder.png" id="character_3_image">
						<div class="input-sections" id="character_3">
							<input class="name" type="text" placeholder="Name" id="character_3_name">
							<select class="gender-dropdown" id="character_3_gender">
								<option value="">Select gender</option>
								<option value="female">female</option>
								<option value="male">male</option>
								<option value="other">other</option>
							</select>
							<div class="mini-heading">appearance</div>
							<textarea class="description" placeholder="What do I look like?"
								id="character_3_look"></textarea>
							<div class="mini-heading">personality</div>
							<textarea class="description" placeholder="Bring me to life!"
								id="character_3_personality"></textarea>
						</div>
						<button class="refresh" id="character_3_refresh"
							onclick="regenerateCharacterImage('character_3')">Regenerate
							Image</button>
					</div>
				</div>
			</div>
			<button onClick="sendSetting()" class="submit-button" id="submit-setting">Construct Universe</button>
		</div>

		<!--Next page-->
		<div class="container">
			<h2>Storyline</h2>
			<textarea class="textbox" maxlength="500" placeholder="What happens next?" id="storyline"></textarea>
			<button class="submit-button" onClick="storyToPanels()">Let your storyline unfold...</button>
		</div>

		<!--Canvas-->
		<div class="container">
			<hr>
			<h2>Layout</h2>
			<div class="containerflex">
				<div class="box1">
					<div class="hiddenradio">
						<label>
							<input type="radio" , name="test" value="big" checked>
							<img src="images/comic layout.png" ,alt="Layout1" , width="80" , height="80">
						</label>
						<label>
							<input type="radio" name="test" value="big">
							<img src="images/comic layout 2.png" ,alt="Layout2" width="80" , height="80">
						</label>
						<label>
							<input type="radio" name="test" value="big">
							<img src="images/comic layout 3.png" ,alt="Layout3" width="80" , height="80">
						</label>
					</div>
				</div>
				<!--choose panels-->
				<div class="box2">
					<select class="dropdown" id="panelselector">
					</select>

				</div>

			</div>
			<div class="container">
				<!-- <style>
					/* Set the width of the columns */
					.column1 {
						width: 30%;
						float: left;
					}

					.column2 {
						width: 70%;
						float: left;
					}
				</style> -->
				<div class="col-left">
					<div id="panel_description_form">
						<hr>
						<h2>Description</h2>
						<textarea class="textbox2" placeholder="Description" id="panel_description"></textarea>
					</div>

					<style>
						/* Style for the dialogue boxes */
						.dialogue {
							display: inline-block;
							padding: 10px;
							background-color: #fff;
							border: 2px solid #67c0c86e;
							border-radius: 15px;
							margin: 5px;
						}

						/* Style for the character names */
						.character-name {
							font-weight: bold;
							margin-right: 10px;
						}
					</style>
					<!-- </head> -->

					<!-- <body> -->
					<!-- First character dialogue -->
					<div class="dialogue">
						<span class="character-name" id="char1">[Character 1]:</span>
						<span class="dialogue-text" id="dialogue1">dialogue</span>
					</div>
					<!-- Second character dialogue -->
					<div class="dialogue">
						<span class="character-name" id="char2">[Character 2]:</span>
						<span class="dialogue-text" id="dialogue2">dialogue</span>
					</div>
					<!-- Third character dialogue -->
					<div class="dialogue">
						<span class="character-name" id="char3">[Character 3]:</span>
						<span class="dialogue-text" id="dialogue3">dialogue</span>
					</div>
					<div class="toppadding">
						<h2>Select an image</h2>
						<input type="file" id="myFileInput">
					</div>

					<div class="toppadding">
						<img id="previewImage" width="300">
					</div>

					<div>
						<button class="submit-button" , onClick="generatePanel()">Generate Panel</button>

					</div>

					<script>
						const fileInput = document.getElementById("myFileInput");
						const previewImage = document.getElementById("previewImage");

						fileInput.addEventListener("change", function () {
							const file = fileInput.files[0];
							const reader = new FileReader();

							reader.addEventListener("load", function () {
								previewImage.src = reader.result;
							}, false);

							if (file) {
								reader.readAsDataURL(file);
							}
						});
					</script>
				</div>
				<div class="col-right">
					<div class="leftmargin">
						<div class="hiddenradio" onChange="selectPreviewImage()" id="preview_selector">
						</div>
					</div>
					<div class="panel">
						<img class="result" src="images/Placeholder3.jpeg" id="panel_img" , width=120%,></img>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>
	<div class="sidebar">
		<select class="character-dropdown" id="chat-select">
			<option value="images/panda.png">Writing Buddy</option>
			<option value="images/character_1.png">Character 1</option>
			<option value="images/character_2.png">Character 2</option>
			<option value="images/character_3.png">Character 3</option>
		</select>
		<div class="speech-bubble" id="chat-speechbubble">
			<p>Are there any specific ideas you have for the story or characters that you'd like me to help with? I'm
				here to help you explore your creativity and bring your vision to life.</p>
		</div>
		<img src="images/panda.png" class="avatar" id="chat-image">
		<textarea class="nonresizable-textbox" id="user-chat-input" placeholder="Ask me anything!"></textarea>
		<button class="send-button" onClick="sendChatRequest()">Send!</button>
		<!-- your additional content here -->
	</div>

	<script>

		let current_image_variations = [];

		//placeholders

		//html stuff
		const selectElement = document.getElementById("panelselector");
		selectElement.addEventListener("change", (event) => {
			let selected = event.target.value;
			document.getElementById("panel_description").value = panels[selected]["scenario_description"];
			dialog_list = panels[selected]['dialogues'];

			// first clear all dialogs
			for (let i = 1; i <= 3; i++) {
				document.getElementById("char" + i).innerHTML = "[Character " + i + "]:";
				document.getElementById("dialogue" + i).innerHTML = "dialogue";
			}

			let i = 1;
			for (var key in dialog_list) {
				if (dialog_list.hasOwnProperty(key)) {
					document.getElementById("char" + i).innerHTML = key;
					document.getElementById("dialogue" + i).innerHTML = dialog_list[key];
					i++;
				}
			}
		});


		// panels[panel1][panel1_image]
		// dynamic list for panels
		var panels = {
			// 1: {
			// 	"scenario_description": "Spiderman and Joker are facing each other on a busy street. The sun is setting in the background, casting an orange glow over the scene. Spiderman is in a crouched position, ready to pounce. Joker is holding a knife, grinning maniacally.\n",
			// 	"dialogues": {
			// 		"Spiderman": "You're not getting away with this, Joker.",
			// 		"Joker": "Oh, but Spiderman, that's the fun part!"
			// 	}
			// }
		}
		// add to selector
		var select = document.getElementById("panelselector");
		for (var i = 1; i <= Object.keys(panels).length; i++) {
			var opt = document.createElement("option");
			opt.value = i;
			opt.innerHTML = "Panel " + i;
			select.appendChild(opt);
		}
		// document.getElementById("panel_description").value = panels[1]["scenario_description"];

		const chatSelector = document.getElementById('chat-select');

		const imageSelector = document.getElementById('chat-select');
		const image = document.getElementById('chat-image');
		const speechBubble = document.getElementById('chat-speechbubble');
		const writingBuddyDefaultText = "Are there any specific ideas you have for the story or characters that you'd like me to help with? I'm here to help you explore your creativity and bring your vision to life."
		const character1DefaultText = "Ask me anything!"

		// add an event listener to the select element
		chatSelector.addEventListener('change', function () {
			// get the selected value
			const selectedValue = chatSelector.value;
			if (chatSelector.selectedIndex == 0) {
				image.src = selectedValue;
			}
			else if (chatSelector.selectedIndex == 1) {
				image.src = document.getElementById("character_1_image").src;
			}
			else if (chatSelector.selectedIndex == 2) {
				image.src = document.getElementById("character_2_image").src;
			}
			else if (chatSelector.selectedIndex == 3) {
				image.src = document.getElementById("character_3_image").src;
			}

			// set the src attribute of the image element to the selected value
			// image.src = selectedValue;
			speechBubble.textContent = (chatSelector.selectedIndex == 0) ? writingBuddyDefaultText : character1DefaultText;

		});

		const char1name = document.getElementById("character_1_name")
		const char2name = document.getElementById("character_2_name")
		const char3name = document.getElementById("character_3_name")
		const chatselect = document.getElementById("chat-select")
		char1name.addEventListener('input', function () {
			// get the value of the input field
			var name = char1name.value;
			// update the text of the selected option
			const selectedOption = chatselect.options[1];
			selectedOption.textContent = name;
		});
		char2name.addEventListener('input', function () {
			// get the value of the input field
			var name = char2name.value;
			// update the text of the selected option
			const selectedOption = chatselect.options[2];
			selectedOption.textContent = name;
		});
		char3name.addEventListener('input', function () {
			// get the value of the input field
			var name = char3name.value;
			// update the text of the selected option
			const selectedOption = chatselect.options[3];
			selectedOption.textContent = name;
		});


		//Communicate with server
		var prefix = 'http://192.168.2.2:6969'


		function parseJSON(response) {
			// Check if the response is valid
			if (!response.ok) {
				throw Error(response.statusText);
			}
			// Parse the JSON from the response
			return response.json();
		}

		function postJSON(data) {
			// Make a POST request to the server with the JSON data
			fetch((prefix + '/global'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => {
					// Handle the response from the server
					console.log(response);
				})
				.catch(error => {
					// Handle any errors that occurred during the request
					console.error(error);
				});
		}


		function sendChatRequest() {
			document.getElementById("chat-speechbubble").textContent = "..."
			const chatSelector = document.getElementById("chat-select");
			var prompt_text = ""
			var character_descriptions = [
				`name: ${document.getElementById("character_1_name").value}
				gender: ${document.getElementById("character_1_gender").value}")}
				appearance: ${document.getElementById("character_1_look").value}
				personality: ${document.getElementById("character_1_personality").value}`,
				`name: ${document.getElementById("character_2_name").value}
				gender: ${document.getElementById("character_2_gender").value}")}
				appearance: ${document.getElementById("character_2_look").value}
				personality: ${document.getElementById("character_2_personality").value}`,
				`name: ${document.getElementById("character_3_name").value}
				gender: ${document.getElementById("character_3_gender").value}")}
				appearance: ${document.getElementById("character_3_look").value}
				personality: ${document.getElementById("character_3_personality").value}`

			];
			//buddy
			if (chatSelector.selectedIndex == 0) {
				prompt_text = `Act as the following character: You are a cute, friendly and happy panda called scribbles, who is an expert on the topic of writing comics and always happy to help. You are focused on helping the user explore their creativity and create a comic from their ideas. This is the story you are trying to help with:

				Setting of the story you are helping with: ${document.getElementById("setting").value}

				Genre of the story you are helping with: ${document.getElementById("genre").value}

				Characters in the story you are helping with: 

				Character 1:
				${character_descriptions[0]}

				Character 2:
				${character_descriptions[1]}

				Character 3:
				${character_descriptions[2]}

				Always answer exactly what your assigned character would answer and never answer as ChatGPT. Answer the question and answer in the tone the character speaks in. You never greet introduce yourself, just answer the question."`;
			}
			else {
				var selectedCharacter = (chatSelector.selectedIndex == 1) ? document.getElementById("character_1").value : (chatSelector.selectedIndex == 2) ? document.getElementById("character_2").value : document.getElementById("character_3").value
				prompt_text = `Act as the following character:
								${character_descriptions[chatSelector.selectedIndex - 1]}

								This is the setting of the world you live in: ${document.getElementById("setting").value}

								These are the other characters who live in your world:
								Character 1:
								${character_descriptions[chatSelector.selectedIndex % 3]}

								Character 2:
								${character_descriptions[(chatSelector.selectedIndex + 1) % 3]}

								Always answer exactly what your assigned chatracter would answer and never answer as chatgpt. Choose suitable details if necessary to answer the question and answer in the tone the character speaks in. You never greet or introduce yourself, just answer the question.`;
			}


			data = {
				system_prompt: prompt_text,
				user_prompt: document.getElementById("user-chat-input").value,
				convo_id: chatSelector.selectedIndex,
			}
			// Make a POST request to the server with the JSON data
			fetch((prefix + '/chat'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => {
					response.json().then(parsedValue => {
						// Handle the response from the server
						console.log(parsedValue)
						document.getElementById("chat-speechbubble").textContent = parsedValue;
					})
				})
				.catch(error => {
					// Handle any errors that occurred during the request
					console.error(error);
				});
		}

		const form = document.getElementById("settingForm");

		function sendSetting() {

			const data = {
				title: document.getElementById("title").value,
				setting: document.getElementById("setting").value,
				style: document.getElementById("style").value,
				genre: document.getElementById("genre").value,
				character_1_name: document.getElementById("character_1_name").value,
				character_1_gender: document.getElementById("character_1_gender").value,
				character_1_look: document.getElementById("character_1_look").value,
				character_1_personality: document.getElementById("character_1_personality").value,
				character_2_name: document.getElementById("character_2_name").value,
				character_2_gender: document.getElementById("character_2_gender").value,
				character_2_look: document.getElementById("character_2_look").value,
				character_2_personality: document.getElementById("character_2_personality").value,
				character_3_name: document.getElementById("character_3_name").value,
				character_3_gender: document.getElementById("character_3_gender").value,
				character_3_look: document.getElementById("character_3_look").value,
				character_3_personality: document.getElementById("character_3_personality").value,
			};

			document.getElementById("storyline").value = "Hold on, currently observing the storyline..."

			// Make a POST request to the server with the JSON data
			fetch((prefix + '/global'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => {
					response.json().then(parsedValue => {
						// code that can access both here
						console.log(parsedValue)
						document.getElementById("storyline").value = parsedValue
						// Get the textarea element
						const textarea = document.getElementById('storyline');

						// Set the initial height of the textarea
						textarea.style.height = 'auto';

						// Set the minimum number of rows to 2
						textarea.setAttribute('rows', '2');

						// Calculate the scroll height of the textarea
						const scrollHeight = textarea.scrollHeight;

						// Set the height of the textarea to the scroll height
						textarea.style.height = scrollHeight + 'px';
					})
				})
				.catch(error => {
					// Handle any errors that occurred during the request
					console.error(error);
				});

		}


		function storyToPanels() {
			const data = {
				title: document.getElementById("title").value,
				storyline: document.getElementById("storyline").value,
			};

			// Make a POST request to the server with the JSON data
			fetch((prefix + '/storyline'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => {
					response.json().then(parsedValue => {
						// code that can access both here
						console.log(parsedValue)
						panels = parsedValue

						// add to selector
						var select = document.getElementById("panelselector");
						// clear the selector
						while (select.firstChild) {
							select.removeChild(select.firstChild);
						}
						for (var i = 1; i <= Object.keys(panels).length; i++) {
							var opt = document.createElement("option");
							opt.value = i;
							opt.innerHTML = "Panel " + i;
							select.appendChild(opt);
						}
						document.getElementById("panel_description").value = panels[1]["scenario_description"];
					})
				})
				.catch(error => {
					// Handle any errors that occurred during the request
					console.error(error);
				});
		}

		function generatePanel() {
			desc = document.getElementById("panel_description").value;
			dialog_list = []
			let data = {
				title: document.getElementById("title").value,
				panel_index: parseInt(document.getElementById("panelselector").value),
				panel_info: {
					scenario_description: desc,
					dialogues: dialog_list
				}
			};
			input_img = document.getElementById("previewImage").src
			if (input_img != "") {
				data["input_img"] = input_img
			}

			//also update the global panels variable
			panels[data.panel_index] = data.panel_info

			// Make a POST request to the server with the JSON data
			fetch((prefix + '/generate_panel'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => {
					// Handle the response from the server
					console.log(response);

					response.json().then(parsedValue => {
						// code that can access both here
						console.log(parsedValue)
						//TODO: decode base64 images and display them (all variations)
						document.getElementById("panel_img").src = "data:image/png;base64," + parsedValue[0]
						current_image_variations = parsedValue
						var previewSelect = document.getElementById("preview_selector");
						previewSelect.innerHTML = "";
						for (var i = 0; i < parsedValue.length; i++) {
							console.log(i)
							var label = document.createElement("label");
							label.innerHTML = `<input type="radio" name="test" value="${i}">
											<img src=${"data:image/png;base64," + parsedValue[i]} ,alt="Layout3" width="80" , height="80">`;
							previewSelect.appendChild(label);
						}
					})
				})
				.catch(error => {
					// Handle any errors that occurred during the request
					console.error(error);
				});
		}

		var select = document.getElementById("panelselector");
		for (var i = 1; i <= Object.keys(panels).length; i++) {
			var opt = document.createElement("option");
			opt.value = i;
			opt.innerHTML = "Panel " + i;
			select.appendChild(opt);
		}


		function selectPreviewImage() {
			var previewSelect = document.getElementById("preview_selector");
			var selectedValue = previewSelect.querySelector('input[name="test"]:checked').value;
			document.getElementById("panel_img").src = "data:image/png;base64," + current_image_variations[selectedValue]
		}

		function regenerateCharacterImage(character_id) {
			var gender = document.getElementById(character_id + "_gender").value == "female" ? "woman" : document.getElementById(character_id + "_gender").value == "male" ? "man" : "androgyne"
			var prompt = `${document.getElementById('style').value} ${document.getElementById(character_id + "_gender").value} comic character avatar, highly detailed portrait, ${gender}, with description ${document.getElementById(character_id + "_look")}, neutral background, ${document.getElementById('genre').value} genre`
			var encodedPrompt = encodeURIComponent(prompt)
			var imageSource = `https://tum-pandas-artist.loophole.site/draw?prompt=%22${encodedPrompt}%22`
			characterImage = document.getElementById(character_id + '_image')
			characterImage.src = imageSource

			//trigger chat update
			const element = document.getElementById('chat-select');
			const event = new Event('change');
			element.dispatchEvent(event);
		}

		function encodebase64image(file) {
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function () {
				console.log(reader.result);
				return reader.result
			};
			reader.onerror = function (error) {
				console.log('Error: ', error);
			};
		}


	</script>

</body>




</html>